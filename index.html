<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chess Openings Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest.json">

<!-- Chessboard.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" xintegrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">

<style>
    :root {
        --bg-color: #2c3e50; 
        --card-bg: #ffffff;
        --text-color: #333;
        --c-0: #bdc3c7; /* Grey */
        --c-1: #8e44ad; /* Purple */
        --c-2: #e67e22; /* Orange */
        --c-3: #f1c40f; /* Yellow */
        --c-4: #2ecc71; /* Green */
        --c-5: #3498db; /* Blue */
    }

    body {
        background-color: var(--bg-color);
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--text-color);
        overflow: hidden; 
    }

    .app-container {
        width: 100%;
        max-width: 450px; /* Tighter width for chess board */
        padding: 15px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .card-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .card {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        position: relative;
        max-height: 75vh;
    }

    .card-header {
        height: 10px;
        background-color: var(--c-0);
        width: 100%;
    }

    .card-content {
        flex: 1;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        overflow-y: auto;
    }

    .q-text {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #2c3e50;
    }

    .a-text {
        font-size: 1.2rem;
        color: #7f8c8d;
    }

    /* Chess Board Styling */
    #myBoard {
        width: 100%;
        max-width: 320px;
        margin: 10px auto;
        pointer-events: none; /* Prevent user dragging pieces */
    }

    /* Controls at bottom */
    .controls {
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 15px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }

    .controls.visible {
        opacity: 1;
        pointer-events: auto;
    }

    .rating-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: none;
        margin: 0 6px;
        color: white;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    
    .rating-btn:active { transform: scale(0.95); }
    .btn-1 { background-color: var(--c-1); }
    .btn-2 { background-color: var(--c-2); }
    .btn-3 { background-color: var(--c-3); }
    .btn-4 { background-color: var(--c-4); }
    .btn-5 { background-color: var(--c-5); }

    .deck-badge {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #ecf0f1;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        color: #7f8c8d;
        text-transform: uppercase;
        font-weight: bold;
    }
</style>
</head>
<body>

<div class="app-container">
    <div id="loading" style="color:white; text-align:center; margin-top:50px;">Loading Chess Engine...</div>

    <div id="gameArea" style="display:none;" class="card-wrapper">
        <div class="card" onclick="revealAnswer()">
            <div class="card-header" id="cardHeader"></div>
            <div class="deck-badge" id="deckBadge">OPENING</div>
            
            <div class="card-content">
                <!-- Board Area -->
                <div id="myBoard"></div>
                
                <!-- Text Area -->
                <div id="textContainer" style="margin-top: 20px;">
                    <div id="mainText" class="q-text">Loading...</div>
                    <div id="subText" class="a-text"></div>
                </div>
            </div>
        </div>

        <div class="controls" id="controls">
            <button class="rating-btn btn-1" onclick="rate(1)">1</button>
            <button class="rating-btn btn-2" onclick="rate(2)">2</button>
            <button class="rating-btn btn-3" onclick="rate(3)">3</button>
            <button class="rating-btn btn-4" onclick="rate(4)">4</button>
            <button class="rating-btn btn-5" onclick="rate(5)">5</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
// -----------------------------
//    STATE
// -----------------------------
let cardsData = [];
let scores = {};
let currentCard = null;
let isAnswerRevealed = false;
let board = null;
let game = new Chess();
let moveInterval = null;

// -----------------------------
//    INIT
// -----------------------------
window.onload = async () => {
    // Load Scores
    const savedScores = localStorage.getItem("flashcard_scores");
    if (savedScores) scores = JSON.parse(savedScores);

    // Load Data
    try {
        const response = await fetch('cards.json');
        cardsData = await response.json();
        
        // Init Board UI
        // We initialize it once, but we'll set position later
        board = Chessboard('myBoard', {
            position: 'start',
            showNotation: true,
            draggable: false
        });

        document.getElementById('loading').style.display = 'none';
        document.getElementById('gameArea').style.display = 'flex';
        
        pickNextCard();
        
        // Handle window resize for responsiveness
        window.addEventListener('resize', () => {
            board.resize();
        });

    } catch (err) {
        document.getElementById('loading').innerText = "Error loading data. Ensure cards.json exists.";
        console.error(err);
    }
};

// -----------------------------
//    ALGORITHM (Weighted)
// -----------------------------
const weights = { 0: 30, 1: 25, 2: 16, 3: 9, 4: 2, 5: 1 };

function pickNextCard() {
    if (cardsData.length === 0) return;

    // Weight logic
    let totalWeight = 0;
    const weightedCards = cardsData.map(c => {
        const s = scores[c.id] || 0; 
        const w = weights[s] || 30;
        totalWeight += w;
        return { ...c, weight: w, currentScore: s };
    });

    let r = Math.random() * totalWeight;
    currentCard = weightedCards[0];
    
    for (let c of weightedCards) {
        r -= c.weight;
        if (r <= 0) {
            currentCard = c;
            break;
        }
    }

    renderCardFront();
}

// -----------------------------
//    RENDER LOGIC
// -----------------------------

function renderCardFront() {
    isAnswerRevealed = false;
    
    // UI Reset
    document.getElementById('controls').classList.remove('visible');
    document.getElementById('cardHeader').style.backgroundColor = `var(--c-${currentCard.currentScore})`;
    document.getElementById('deckBadge').innerText = currentCard.tag || "CHESS";

    // Mode: "Guess the Opening"
    // We show the moves being played on the board, user guesses name
    
    // 1. Text Setup
    document.getElementById('mainText').innerText = "Guess the Opening";
    document.getElementById('mainText').style.fontSize = "1.2rem";
    document.getElementById('mainText').style.color = "#7f8c8d";
    document.getElementById('subText').innerText = "(Watch the board)";
    
    // 2. Board Setup & Animation
    playOpening(currentCard.pgn);
}

function revealAnswer() {
    if (isAnswerRevealed) return;
    isAnswerRevealed = true;

    // Show Name
    document.getElementById('mainText').innerText = currentCard.front; // e.g. "Sicilian Defense"
    document.getElementById('mainText').style.fontSize = "1.8rem";
    document.getElementById('mainText').style.color = "#2c3e50";
    
    // Show PGN text
    document.getElementById('subText').innerText = currentCard.back; // e.g. "1. e4 c5"

    // Show Buttons
    document.getElementById('controls').classList.add('visible');
}

// -----------------------------
//    CHESS LOGIC
// -----------------------------
function playOpening(pgn) {
    // Stop any existing loop
    if (moveInterval) clearInterval(moveInterval);
    
    game.reset();
    board.position('start');

    // Parse PGN to get clean move list
    // We load PGN into game to validate it, then get history
    const loadSuccess = game.load_pgn(pgn);
    if(!loadSuccess) {
        console.error("Invalid PGN", pgn);
        return;
    }
    
    const moves = game.history(); // Array of SAN moves like ['e4', 'c5']
    game.reset(); // Reset to start so we can play them one by one
    
    let moveIndex = 0;
    
    // Initial delay before moving
    setTimeout(() => {
        moveInterval = setInterval(() => {
            if (moveIndex >= moves.length) {
                // End of opening reached, pause then restart
                clearInterval(moveInterval);
                setTimeout(() => {
                    if (currentCard.pgn === pgn && !isAnswerRevealed) playOpening(pgn); // Loop if still on same card
                }, 2000);
                return;
            }

            game.move(moves[moveIndex]);
            board.position(game.fen());
            moveIndex++;
            
        }, 800); // Speed of moves (ms)
    }, 500);
}

function rate(score) {
    scores[currentCard.id] = score;
    localStorage.setItem("flashcard_scores", JSON.stringify(scores));
    pickNextCard();
}

// Service Worker
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
