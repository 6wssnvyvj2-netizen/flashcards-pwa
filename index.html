<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chess Openings Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="manifest" href="manifest.json">

<!-- Chessboard.js CSS -->
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" xintegrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">

<style>
    :root {
        --bg-color: #2c3e50; 
        --card-bg: #ffffff;
        --text-color: #333;
        --c-0: #bdc3c7; /* Grey */
        --c-1: #8e44ad; /* Purple */
        --c-2: #e67e22; /* Orange */
        --c-3: #f1c40f; /* Yellow */
        --c-4: #2ecc71; /* Green */
        --c-5: #3498db; /* Blue */
    }

    body {
        background-color: var(--bg-color);
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--text-color);
        overflow: hidden; 
    }

    .app-container {
        width: 100%;
        max-width: 450px; 
        padding: 15px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .card-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .card {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        position: relative;
        max-height: 80vh; 
    }

    .card-header {
        height: 10px;
        background-color: var(--c-0);
        width: 100%;
    }

    .card-content {
        flex: 1;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        text-align: center;
        overflow-y: auto;
    }

    .q-text {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0.5rem 0;
        color: #2c3e50;
    }

    .a-text {
        font-size: 1.1rem;
        color: #7f8c8d;
        min-height: 1.5rem;
    }

    /* Chess Board Styling */
    #myBoard {
        width: 100%;
        max-width: 340px; 
        margin: 10px auto;
        touch-action: pan-y; 
    }

    /* Controls at bottom */
    .controls {
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
    }

    .controls.visible {
        opacity: 1;
        pointer-events: auto;
    }

    .rating-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: none;
        margin: 0 6px;
        color: white;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        transition: transform 0.1s;
    }
    
    .rating-btn:active { transform: scale(0.95); }
    .btn-1 { background-color: var(--c-1); }
    .btn-2 { background-color: var(--c-2); }
    .btn-3 { background-color: var(--c-3); }
    .btn-4 { background-color: var(--c-4); }
    .btn-5 { background-color: var(--c-5); }

    .deck-badge {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #ecf0f1;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        color: #7f8c8d;
        text-transform: uppercase;
        font-weight: bold;
    }

    .flip-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        background: none;
        border: 1px solid #ccc;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        color: #7f8c8d;
        cursor: pointer;
        z-index: 10;
    }
    
    .flip-btn:hover { background-color: #f0f0f0; }
</style>
</head>
<body>

<div class="app-container">
    <div id="loading" style="color:white; text-align:center; margin-top:50px;">Loading Chess Engine...</div>

    <div id="gameArea" style="display:none;" class="card-wrapper">
        <div class="card" onclick="revealAnswer()">
            <div class="card-header" id="cardHeader"></div>
            
            <button class="flip-btn" onclick="toggleOrientation(event)">FLIP BOARD</button>
            <div class="deck-badge" id="deckBadge">OPENING</div>
            
            <div class="card-content">
                <!-- Text Area Top -->
                <div id="textContainer">
                    <div id="mainText" class="q-text">Loading...</div>
                    <div id="subText" class="a-text"></div>
                </div>

                <!-- Board Area -->
                <div id="myBoard"></div>
            </div>
        </div>

        <div class="controls" id="controls">
            <button class="rating-btn btn-1" onclick="rate(1)">1</button>
            <button class="rating-btn btn-2" onclick="rate(2)">2</button>
            <button class="rating-btn btn-3" onclick="rate(3)">3</button>
            <button class="rating-btn btn-4" onclick="rate(4)">4</button>
            <button class="rating-btn btn-5" onclick="rate(5)">5</button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
// -----------------------------
//    ASSETS (Wikimedia SVGs)
// -----------------------------
function getPieceImg(piece) {
    // Map standard ChessboardJS piece codes (wP, bK, etc) to Wikimedia Commons URLs
    const map = {
        'wP': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
        'wN': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
        'wB': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
        'wR': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
        'wQ': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
        'wK': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg',
        'bP': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
        'bN': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
        'bB': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
        'bR': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
        'bQ': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
        'bK': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
    };
    return map[piece] || '';
}

// -----------------------------
//    STATE
// -----------------------------
let cardsData = [];
let scores = {};
let currentCard = null;
let isAnswerRevealed = false;
let board = null;
let game = new Chess();
let moveInterval = null;
let userOrientation = 'white';

// -----------------------------
//    INIT
// -----------------------------
window.onload = async () => {
    const savedScores = localStorage.getItem("flashcard_scores");
    if (savedScores) scores = JSON.parse(savedScores);

    try {
        const response = await fetch('cards.json');
        cardsData = await response.json();
        
        // --- FIXED: Use custom function for images ---
        board = Chessboard('myBoard', {
            position: 'start',
            showNotation: true,
            draggable: false,
            pieceTheme: getPieceImg // Calls our function above
        });

        document.getElementById('loading').style.display = 'none';
        document.getElementById('gameArea').style.display = 'flex';
        
        setTimeout(() => { board.resize(); }, 100);
        pickNextCard();
        window.addEventListener('resize', () => { board.resize(); });

    } catch (err) {
        document.getElementById('loading').innerText = "Error loading data. Ensure cards.json exists.";
        console.error(err);
    }
};

// -----------------------------
//    ALGORITHM
// -----------------------------
const weights = { 0: 30, 1: 25, 2: 16, 3: 9, 4: 2, 5: 1 };

function pickNextCard() {
    if (cardsData.length === 0) return;

    let totalWeight = 0;
    const weightedCards = cardsData.map(c => {
        const s = scores[c.id] || 0; 
        const w = weights[s] || 30;
        totalWeight += w;
        return { ...c, weight: w, currentScore: s };
    });

    let r = Math.random() * totalWeight;
    currentCard = weightedCards[0];
    
    for (let c of weightedCards) {
        r -= c.weight;
        if (r <= 0) {
            currentCard = c;
            break;
        }
    }

    renderCardFront();
}

// -----------------------------
//    RENDER LOGIC
// -----------------------------

function renderCardFront() {
    isAnswerRevealed = false;
    
    document.getElementById('controls').classList.remove('visible');
    document.getElementById('cardHeader').style.backgroundColor = `var(--c-${currentCard.currentScore})`;
    document.getElementById('deckBadge').innerText = currentCard.tag || "CHESS";

    // Text Setup
    document.getElementById('mainText').innerText = "Guess the Opening";
    document.getElementById('mainText').style.fontSize = "1.5rem";
    document.getElementById('mainText').style.color = "#7f8c8d";
    document.getElementById('subText').innerText = "(Watch the board)";
    
    // Board Setup
    board.orientation(userOrientation);
    playOpening(currentCard.pgn);
}

function revealAnswer() {
    if (isAnswerRevealed) return;
    isAnswerRevealed = true;

    // Show Name
    document.getElementById('mainText').innerText = currentCard.front; 
    document.getElementById('mainText').style.fontSize = "2rem";
    document.getElementById('mainText').style.color = "#2c3e50";
    
    // Show PGN
    document.getElementById('subText').innerText = currentCard.back; 

    // Show Buttons
    document.getElementById('controls').classList.add('visible');
}

// -----------------------------
//    CHESS LOGIC
// -----------------------------
function playOpening(pgn) {
    if (moveInterval) clearInterval(moveInterval);
    
    game.reset();
    board.position('start');

    const loadSuccess = game.load_pgn(pgn);
    if(!loadSuccess) return;
    
    const moves = game.history(); 
    game.reset(); 
    
    let moveIndex = 0;
    
    setTimeout(() => {
        moveInterval = setInterval(() => {
            if (moveIndex >= moves.length) {
                clearInterval(moveInterval);
                setTimeout(() => {
                    // Replay if same card
                    if (currentCard.pgn === pgn && !isAnswerRevealed) playOpening(pgn); 
                }, 2000);
                return;
            }

            game.move(moves[moveIndex]);
            board.position(game.fen());
            moveIndex++;
            
        }, 800); 
    }, 500);
}

function toggleOrientation(e) {
    e.stopPropagation(); // Stop card flip
    userOrientation = userOrientation === 'white' ? 'black' : 'white';
    board.orientation(userOrientation);
}

function rate(score) {
    scores[currentCard.id] = score;
    localStorage.setItem("flashcard_scores", JSON.stringify(scores));
    pickNextCard();
}

if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>

